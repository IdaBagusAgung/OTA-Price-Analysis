{% extends "base.html" %}

{% block content %}

<!-- Result Header -->
<section class="hero-section">
    <div class="container">
        <h1><i class="fas fa-chart-line"></i> Price Prediction Results</h1>
        <p class="lead">Your AI-powered price analysis is ready</p>
    </div>
</section>

<style>
/* üåà Header Style */
.card-header {
    background: linear-gradient(135deg, #005bea, #00c6fb);
    color: #fff;
    text-align: center;
    padding: 18px;
    border-top-left-radius: 16px;
    border-top-right-radius: 16px;
    box-shadow: 0 3px 8px rgba(0, 0, 0, 0.2);
}
.card-header h3 {
    margin: 0;
    font-family: 'Poppins', sans-serif;
    font-weight: 600;
    font-size: 1.4rem;
    letter-spacing: 0.5px;
}

/* üí∞ Price Display Section */
.price-display {
    max-width: 400px;
    margin: 0 auto 30px;
    padding: 28px;
    background: linear-gradient(145deg, #f4f7fb, #e6ecf2);
    border-radius: 0 0 16px 16px;
    box-shadow: 0 6px 18px rgba(0, 0, 0, 0.1);
    text-align: center;
    font-family: 'Poppins', sans-serif;
    transition: all 0.3s ease;
}
.price-display:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
}

/* üí∏ Price Text */
.price-amount {
    font-size: 2.8rem;
    font-weight: 700;
    color: #0078d7;
    margin-bottom: 10px;
}

/* üí¨ Currency and Total Info */
.currency-info {
    font-size: 1rem;
    color: #555;
    margin-bottom: 6px;
}

.total-info {
    font-size: 0.9rem;
    color: #777;
    margin-bottom: 12px;
}

/* üîÑ Exchange Info Box */
.exchange-info {
    display: inline-block;
    background: #ffffff;
    padding: 10px 14px;
    border-radius: 10px;
    font-size: 0.85rem;
    color: #333;
    line-height: 1.4;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.exchange-info .info-icon {
    margin-right: 5px;
    color: #0078d7;
    font-weight: bold;
}

.exchange-info strong {
    color: #111;
}

/* ‚ú® Optional Hover Glow */
.price-amount, .card-header h3 {
    text-shadow: 0 0 8px rgba(0, 123, 255, 0.3);
}
</style>

<!-- Main Results -->
<section class="py-5">
    <div class="container">
        <!-- Prediction Result Card -->
        <div class="row justify-content-center mb-4">
            <div class="col-lg-8">
                <div class="card shadow-lg border-0">
                    <div class="card-header">
                        <h3><i class="fas fa-dollar-sign"></i> Predicted Price</h3>
                    </div>
                    <div class="card-body text-center p-4">
                        <div class="price-display">
                            <h1 class="price-amount">{{ result.formatted_price }}</h1>
                            <p class="currency-info">
                                {{ result.display_currency }} per night
                            </p>

                            {% if result.stay_duration > 1 %}
                            <p class="total-info">
                                {{ result.formatted_total }} total for {{ result.stay_duration }} nights
                            </p>
                            {% endif %}

                            {% if result.display_currency != 'USD' %}
                            <div class="exchange-info">
                                <span class="info-icon">‚ÑπÔ∏è</span>
                                Original: <strong>${{ "%.2f"|format(result.predicted_price_usd) }}</strong> USD<br>
                                <small>
                                    (Rate: 1 USD = 
                                    {% if result.display_currency == 'IDR' %}
                                        {{ "%.0f"|format(result.exchange_rate) }}
                                    {% else %}
                                        {{ "%.2f"|format(result.exchange_rate) }}
                                    {% endif %}
                                    {{ result.display_currency }})
                                </small>
                            </div>
                            {% endif %}
                        </div>


                        <!-- Confidence Indicator -->
                        {% if confidence %}
                        <div class="mt-3">
                            <div class="row justify-content-center">
                                <div class="col-md-6">
                                    <label class="form-label">Prediction Confidence</label>
                                    <div class="progress mb-2">
                                        <div class="progress-bar bg-success" role="progressbar" 
                                             style="width: {{ confidence }}%" 
                                             aria-valuenow="{{ confidence }}" aria-valuemin="0" aria-valuemax="100">
                                            {{ "%.1f"|format(confidence) }}%
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Input Summary & Price Breakdown -->
        <div class="row">
            <!-- Input Summary -->
            <div class="col-lg-6 mb-4">
                <div class="card h-100">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-list-check"></i> Booking Details</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-borderless">
                                <tbody>
                                    <tr>
                                        <td><i class="fas fa-calendar-days text-primary"></i> <strong>Stay Duration:</strong></td>
                                        <td>{{ result.stay_duration }} night{{ 's' if result.stay_duration != 1 else '' }}</td>
                                    </tr>
                                    <tr>
                                        <td><i class="fas fa-calendar-alt text-primary"></i> <strong>Check-in Month:</strong></td>
                                        <td>{% set months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'] %}{{ months[result.check_in_month - 1] if result.check_in_month else 'Unknown' }}</td>
                                    </tr>
                                    <tr>
                                        <td><i class="fas fa-leaf text-primary"></i> <strong>Season:</strong></td>
                                        <td>{{ result.season }}</td>
                                    </tr>
                                    <tr>
                                        <td><i class="fas fa-calendar-weekend text-primary"></i> <strong>Booking Type:</strong></td>
                                        <td>{{ 'Weekend' if result.is_weekend else 'Weekday' }}</td>
                                    </tr>
                                    <tr>
                                        <td><i class="fas fa-money-bill text-primary"></i> <strong>Input Currency:</strong></td>
                                        <td>{{ result.currency }}</td>
                                    </tr>
                                    <tr>
                                        <td><i class="fas fa-exchange-alt text-primary"></i> <strong>Display Currency:</strong></td>
                                        <td>{{ result.display_currency }}</td>
                                    </tr>
                                    <tr>
                                        <td><i class="fas fa-globe text-primary"></i> <strong>Market:</strong></td>
                                        <td>{{ result.locale }}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Price Analysis -->
            <div class="col-lg-6 mb-4">
                <div class="card h-100">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-chart-pie"></i> Price Analysis</h5>
                    </div>
                    <div class="card-body">
                        <!-- Price Range Indicator -->
                        <div class="mb-4">
                            <label class="form-label"><strong>Price Category</strong></label>
                            {% set price_usd = result.predicted_price_usd %}
                            {% set price_category = 'Budget' if price_usd < 50 else ('Mid-range' if price_usd < 150 else 'Premium') %}
                            <div class="alert alert-{{ 'success' if price_category == 'Budget' else ('warning' if price_category == 'Mid-range' else 'info') }}">
                                <i class="fas fa-tag"></i> {{ price_category }} Pricing
                                <br><small>
                                    {% if price_category == 'Budget' %}
                                        Great value for budget-conscious travelers
                                    {% elif price_category == 'Mid-range' %}
                                        Competitive pricing with good amenities
                                    {% else %}
                                        Premium experience with luxury features
                                    {% endif %}
                                </small>
                            </div>
                        </div>

                        <!-- Seasonal Impact -->
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <span><i class="fas fa-seedling"></i> <strong>Seasonal Impact:</strong></span>
                                <span class="badge bg-{{ 'danger' if result.season in ['Summer', 'Winter'] else 'success' }}">
                                    {{ 'High demand' if result.season in ['Summer', 'Winter'] else 'Regular demand' }}
                                </span>
                            </div>
                        </div>

                        <!-- Weekend Premium -->
                        {% if result.is_weekend %}
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <span><i class="fas fa-calendar-weekend"></i> <strong>Weekend Premium:</strong></span>
                                <span class="badge bg-info">+15-25%</span>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Market Insights -->
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <span><i class="fas fa-globe-americas"></i> <strong>Market Demand:</strong></span>
                                <span class="badge bg-{{ 'success' if result.locale in ['en-US', 'en-GB'] else 'secondary' }}">
                                    {{ 'High' if result.locale in ['en-US', 'en-GB'] else 'Moderate' }}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- All Models Predictions -->
        {% if result.all_model_predictions %}
        <div class="row mb-4">
            <div class="col-12">
                <div class="card bg-white">
                    <div class="card-header bg-gradient text-white">
                        <h5 class="mb-0"><i class="fas fa-brain"></i> Predictions from All Models ({{ result.all_model_predictions|length }} Models)</h5>
                    </div>
                    <div class="card-body">
                        <!-- Ensemble Statistics - Enhanced -->
                        {% if result.ensemble_stats %}
                        <div class="mb-4">
                            <h6 class="text-dark mb-3"><i class="fas fa-chart-bar"></i> Multi-Model Price Summary</h6>
                            <div class="row g-3">
                                <!-- Minimum Price - Green -->
                                <div class="col-md-4">
                                    <div class="card border-success h-100">
                                        <div class="card-body text-center" style="background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);">
                                            <div class="mb-2">
                                                <i class="fas fa-arrow-down fa-2x text-success"></i>
                                            </div>
                                            <h6 class="text-success mb-1">Lowest Prediction</h6>
                                            <h3 class="fw-bold text-success mb-0">
                                                {{ result.ensemble_stats.min }}
                                            </h3>
                                            <small class="text-muted">{{ result.display_currency }}</small>
                                        </div>
                                    </div>
                                </div>

                                <!-- Average Price - Blue -->
                                <div class="col-md-4">
                                    <div class="card border-primary h-100">
                                        <div class="card-body text-center" style="background: linear-gradient(135deg, #cfe2ff 0%, #b6d4fe 100%);">
                                            <div class="mb-2">
                                                <i class="fas fa-balance-scale fa-2x text-primary"></i>
                                            </div>
                                            <h6 class="text-primary mb-1">Average Prediction</h6>
                                            <h3 class="fw-bold text-primary mb-0">
                                                {{ result.ensemble_stats.average }}
                                            </h3>
                                            <small class="text-muted">{{ result.display_currency }} (from {{ result.ensemble_stats.count }} models)</small>
                                        </div>
                                    </div>
                                </div>

                                <!-- Maximum Price - Red -->
                                <div class="col-md-4">
                                    <div class="card border-danger h-100">
                                        <div class="card-body text-center" style="background: linear-gradient(135deg, #f8d7da 0%, #f1aeb5 100%);">
                                            <div class="mb-2">
                                                <i class="fas fa-arrow-up fa-2x text-danger"></i>
                                            </div>
                                            <h6 class="text-danger mb-1">Highest Prediction</h6>
                                            <h3 class="fw-bold text-danger mb-0">
                                                {{ result.ensemble_stats.max }}
                                            </h3>
                                            <small class="text-muted">{{ result.display_currency }}</small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Additional Stats Row -->
                            <div class="row g-2 mt-2">
                                <div class="col-md-6">
                                    <div class="card bg-light">
                                        <div class="card-body py-2 text-center">
                                            <small class="text-muted">Median:</small>
                                            <strong class="ms-2">{{ result.ensemble_stats.median }}</strong>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card bg-light">
                                        <div class="card-body py-2 text-center">
                                            <small class="text-muted">Std Deviation:</small>
                                            <strong class="ms-2">{{ result.ensemble_stats.std }}</strong>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Price Range Info -->
                            <div class="alert alert-light mt-3 mb-0">
                                <small class="text-muted">
                                    <i class="fas fa-info-circle"></i> 
                                    <strong>Price Range:</strong> Based on {{ result.ensemble_stats.count }} different ML models, 
                                    predictions range from <strong class="text-success">{{ result.ensemble_stats.min }}</strong> 
                                    to <strong class="text-danger">{{ result.ensemble_stats.max }}</strong>, 
                                    with an average of <strong class="text-primary">{{ result.ensemble_stats.average }}</strong>.
                                </small>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Models Table -->
                        <div class="table-responsive">
                            <h6 class="text-dark mb-3"><i class="fas fa-table"></i> Detailed Model Predictions</h6>
                            <table class="table table-hover model-predictions-table" style="background-color: #ffffff;">
                                <thead style="background-color: #f8f9fa;">
                                    <tr>
                                        <th class="text-dark" style="width: 5%;">#</th>
                                        <th class="text-dark" style="width: 30%;">Model Name</th>
                                        <th class="text-dark" style="width: 15%;">Category</th>
                                        <th class="text-dark" style="width: 15%;">Predicted Price</th>
                                        <th class="text-dark text-center" style="width: 10%;">R¬≤ Score</th>
                                        <th class="text-dark text-center" style="width: 10%;">RMSE</th>
                                        <th class="text-dark text-center" style="width: 10%;">MAE</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for model in result.all_model_predictions %}
                                    <tr class="{{ 'table-success' if loop.index == 1 else '' }}" style="border-bottom: 1px solid #dee2e6;">
                                        <td class="text-dark">
                                            {% if loop.index == 1 %}
                                            <i class="fas fa-trophy text-warning"></i>
                                            {% else %}
                                            {{ loop.index }}
                                            {% endif %}
                                        </td>
                                        <td class="text-dark">
                                            <strong>{{ model.model_name }}</strong>
                                            {% if loop.index == 1 %}
                                            <span class="badge bg-success ms-2"><i class="fas fa-star"></i> Best R¬≤</span>
                                            {% elif loop.index <= 3 %}
                                            <span class="badge bg-info ms-2">Top 3</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if model.category == 'traditional_ml' %}
                                            <span class="badge bg-primary">
                                                <i class="fas fa-brain"></i> Traditional ML
                                            </span>
                                            {% elif model.category == 'ensemble_models' %}
                                            <span class="badge bg-success">
                                                <i class="fas fa-layer-group"></i> Ensemble
                                            </span>
                                            {% else %}
                                            <span class="badge bg-info">
                                                <i class="fas fa-robot"></i> Deep Learning
                                            </span>
                                            {% endif %}
                                        </td>
                                        <td class="text-dark">
                                            <strong style="font-size: 1.1em;">{{ model.formatted_price }}</strong>
                                            {% if model.prediction == result.ensemble_stats.min_raw %}
                                            <span class="badge bg-success ms-1">Lowest</span>
                                            {% elif model.prediction == result.ensemble_stats.max_raw %}
                                            <span class="badge bg-danger ms-1">Highest</span>
                                            {% endif %}
                                        </td>
                                        <td class="text-center text-dark">
                                            <span class="badge {{ 'bg-success' if model.r2_score > 0.7 else ('bg-warning text-dark' if model.r2_score > 0.5 else 'bg-secondary') }}">
                                                {{ "%.4f"|format(model.r2_score) }}
                                            </span>
                                        </td>
                                        <td class="text-center text-dark">
                                            <small>{{ "%.2f"|format(model.rmse) }}</small>
                                        </td>
                                        <td class="text-center text-dark">
                                            <small>{{ "%.2f"|format(model.mae) }}</small>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                            
                            <!-- Model Performance Legend -->
                            <div class="mt-3">
                                <small class="text-muted">
                                    <strong>Legend:</strong> 
                                    <span class="badge bg-success ms-2">R¬≤ > 0.7</span>
                                    <span class="badge bg-warning text-dark ms-2">R¬≤ > 0.5</span>
                                    <span class="badge bg-secondary ms-2">R¬≤ ‚â§ 0.5</span>
                                    | 
                                    <i class="fas fa-trophy text-warning ms-2"></i> = Best Model
                                    <span class="badge bg-success ms-2">Lowest</span> = Cheapest Prediction
                                    <span class="badge bg-danger ms-2">Highest</span> = Most Expensive Prediction
                                </small>
                            </div>
                        </div>

                        <div class="alert alert-light mt-3">
                            <i class="fas fa-info-circle"></i> 
                            <strong>Note:</strong> The main prediction uses the <strong>{{ result.model_info.model_type }}</strong> model 
                            (ranked #{{ result.all_model_predictions.index(result.all_model_predictions|selectattr('model_name', 'equalto', result.model_info.model_type)|first) + 1 if result.all_model_predictions|selectattr('model_name', 'equalto', result.model_info.model_type)|list else 1 }} by R¬≤ score).
                            You can see predictions from all {{ result.all_model_predictions|length }} trained models above for comparison.
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Pricing Recommendations -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-lightbulb"></i> Pricing Recommendations</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <div class="recommendation-item">
                                    <h6 class="text-success"><i class="fas fa-arrow-down"></i> Competitive Rate</h6>
                                    {% if result.display_currency == 'IDR' %}
                                        <p class="mb-0">Rp {{ "{:,.0f}".format(result.predicted_price * 0.9) }}</p>
                                    {% else %}
                                        <p class="mb-0">${{ "%.2f"|format(result.predicted_price * 0.9) }}</p>
                                    {% endif %}
                                    <small class="text-muted">10% below prediction to attract more bookings</small>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <div class="recommendation-item">
                                    <h6 class="text-primary"><i class="fas fa-bullseye"></i> Optimal Rate</h6>
                                    <p class="mb-0">{{ result.formatted_price }}</p>
                                    <small class="text-muted">AI-recommended price for best balance</small>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <div class="recommendation-item">
                                    <h6 class="text-warning"><i class="fas fa-arrow-up"></i> Premium Rate</h6>
                                    {% if result.display_currency == 'IDR' %}
                                        <p class="mb-0">Rp {{ "{:,.0f}".format(result.predicted_price * 1.15) }}</p>
                                    {% else %}
                                        <p class="mb-0">${{ "%.2f"|format(result.predicted_price * 1.15) }}</p>
                                    {% endif %}
                                    <small class="text-muted">15% premium for unique properties</small>
                                </div>
                            </div>
                        </div>

                        <!-- Additional Tips -->
                        <div class="alert alert-light mt-3">
                            <h6><i class="fas fa-tips"></i> Pricing Tips:</h6>
                            <ul class="mb-0">
                                <li>Consider offering discounts for longer stays (7+ nights)</li>
                                <li>Adjust prices based on local events and holidays</li>
                                <li>Monitor competitor pricing regularly</li>
                                {% if result.season in ['Summer', 'Winter'] %}
                                <li>Peak season detected - consider premium pricing strategy</li>
                                {% endif %}
                                {% if result.is_weekend %}
                                <li>Weekend booking - weekend premiums typically apply</li>
                                {% endif %}
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="row mt-4">
            <div class="col-12 text-center">
                <a href="{{ url_for('index') }}" class="btn btn-primary btn-lg me-3">
                    <i class="fas fa-redo"></i> New Prediction
                </a>
                <a href="{{ url_for('analytics') }}" class="btn btn-outline-info btn-lg">
                    <i class="fas fa-chart-bar"></i> View Analytics
                </a>
            </div>
        </div>
    </div>
</section>

<script>
// Add some interactive elements
document.addEventListener('DOMContentLoaded', function() {
    // Animate the price on load
    const priceElement = document.querySelector('.price-display h1');
    if (priceElement) {
        priceElement.style.opacity = '0';
        priceElement.style.transform = 'scale(0.8)';
        setTimeout(() => {
            priceElement.style.transition = 'all 0.5s ease-out';
            priceElement.style.opacity = '1';
            priceElement.style.transform = 'scale(1)';
        }, 100);
    }
    
    // Add click-to-copy functionality for prices
    document.querySelectorAll('.recommendation-item p').forEach(element => {
        element.style.cursor = 'pointer';
        element.title = 'Click to copy';
        element.addEventListener('click', function() {
            const text = this.textContent;
            navigator.clipboard.writeText(text).then(() => {
                // Show temporary feedback
                const original = this.textContent;
                this.textContent = 'Copied!';
                this.style.color = '#28a745';
                setTimeout(() => {
                    this.textContent = original;
                    this.style.color = '';
                }, 1000);
            });
        });
    });
});
</script>

{% endblock %}